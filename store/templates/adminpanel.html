<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="msapplication-TileColor" content="#6a1b9a">
    <link rel="icon" href="{% static 'img/logo-kudumbashree.png' %}" type="image/x-icon">
    <title>Admin Panel - Kudumbasree</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* Ensure table layout is consistent */
        table {
            table-layout: fixed;
            width: 100%;
        }
        .active-link {
            background-color: #87267e;
            color: white;
        }
    </style>
</head>
<body class="bg-white text-gray-800 antialiased">

    <div class="flex min-h-screen">
        <aside class="w-64 bg-gray-50 border-r border-gray-200 flex-col p-4 hidden md:flex">
            <div class="text-2xl font-bold text-[#87267e] mb-10 text-center">
                <a href="{% url 'admin_dashboard' %}" class="flex items-center space-x-2 text-2xl font-bold text-primary">
                <img src="{% static 'img/logo-kudumbashree.png' %}" alt="Logo" class="h-12 w-12">
                <span>Admin Panel</span>
                </a>
            </div>
            <nav>
                <ul class="space-y-2">
                    <li>
                        <a href="#sales-report" class="nav-link flex items-center p-3 rounded-lg text-gray-700" data-target="sales-report-section">
                            <i class="fas fa-chart-line w-6 text-center"></i>
                            <span class="ml-4 font-medium">Sales Report</span>
                        </a>
                    </li>
                    <li>
                        <a href="#customers" class="nav-link flex items-center p-3 rounded-lg text-gray-700" data-target="customers-section">
                            <i class="fas fa-users w-6 text-center"></i>
                            <span class="ml-4 font-medium">Customers</span>
                        </a>
                    </li>
                    <li>
                        <a href="#sellers" class="nav-link flex items-center p-3 rounded-lg text-gray-700" data-target="sellers-section">
                            <i class="fas fa-store w-6 text-center"></i>
                            <span class="ml-4 font-medium">Sellers</span>
                        </a>
                    </li>
                    <li>
                        <a href="#approval" class="nav-link flex items-center p-3 rounded-lg text-gray-700" data-target="approval-section">
                            <i class="fas fa-user-check w-6 text-center"></i>
                            <span class="ml-4 font-medium">Seller Approval</span>
                        </a>
                    </li>
                    <li>
                        <a href="#community" class="nav-link flex items-center p-3 rounded-lg text-gray-700" data-target="community-section">
                            <i class="fas fa-bullhorn w-6 text-center"></i>
                            <span class="ml-4 font-medium">Community Post</span>
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'logout' %}" class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-500 hover:text-white transition-colors duration-200 mt-8">
                            <i class="fas fa-sign-out-alt w-6 text-center"></i>
                            <span class="ml-4 font-medium">Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="flex-1 p-6 md:p-10 bg-white">
            {% if messages %}
                <div class="p-4 space-y-2">
                    {% for message in messages %}
                        <div class="auto-dismiss-alert p-3 rounded-lg text-center text-sm font-medium transition-opacity duration-500
                            {% if message.tags == 'success' %} bg-green-100 text-green-800 {% endif %}
                            {% if message.tags == 'error' or message.tags == 'warning' %} bg-red-100 text-red-800 {% endif %}
                            {% if message.tags == 'info' %} bg-blue-100 text-blue-800 {% endif %}"
                            role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <header class="md:hidden flex justify-between items-center mb-6">
                 <h1 class="text-2xl font-bold text-[#87267e]">Admin Panel</h1>
                 <button id="mobile-menu-btn" class="p-2">
                     <i class="fas fa-bars text-2xl"></i>
                 </button>
            </header>
            
            <div id="mobile-nav-menu" class="md:hidden hidden mb-6">
                 <nav>
                     <ul class="space-y-2">
                         <li><a href="#sales-report" class="nav-link flex items-center p-3 rounded-lg text-gray-700" data-target="sales-report-section"><i class="fas fa-chart-line w-6 text-center"></i><span class="ml-4 font-medium">Sales Report</span></a></li>
                         <li><a href="#customers" class="nav-link block p-3 rounded-lg hover:bg-[#87267e] hover:text-white" data-target="customers-section">Customers</a></li>
                         <li><a href="#sellers" class="nav-link block p-3 rounded-lg hover:bg-[#87267e] hover:text-white" data-target="sellers-section">Sellers</a></li>
                         <li><a href="#approval" class="nav-link block p-3 rounded-lg hover:bg-[#87267e] hover:text-white" data-target="approval-section">Seller Approval</a></li>
                         <li><a href="#community" class="nav-link flex items-center p-3 rounded-lg text-gray-700" data-target="community-section"><i class="fas fa-bullhorn w-6 text-center"></i><span class="ml-4 font-medium">Community Post</span></a></li>
                         <li><a href="{% url 'logout' %}" class="block p-3 rounded-lg hover:bg-red-500 hover:text-white mt-4">Logout</a></li>
                     </ul>
                 </nav>
            </div>
            
            <section id="sales-report-section" class="content-section">
                <h2 class="text-3xl font-bold text-gray-700 mb-6">Sales Report</h2>
                
                <form method="get" action="{% url 'admin_dashboard' %}#sales-report" class="bg-gray-50 p-4 rounded-lg shadow-sm border mb-6 flex flex-col md:flex-row gap-4 items-center">
                    <div class="w-full md:w-1/3">
                        <label for="month" class="block text-sm font-medium text-gray-700">Month</label>
                        <select name="month" id="month" class="w-full mt-1 rounded-md border-gray-300 shadow-sm">
                            {% for month in months %}
                                <option value="{{ month.value }}" {% if month.value == selected_month %}selected{% endif %}>{{ month.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="w-full md:w-1/3">
                        <label for="year" class="block text-sm font-medium text-gray-700">Year</label>
                        <select name="year" id="year" class="w-full mt-1 rounded-md border-gray-300 shadow-sm">
                            {% for year in years %}
                                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="w-full md:w-auto bg-[#87267e] text-white font-semibold py-2 px-6 rounded-lg self-end">Generate</button>
                </form>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600"><i class="fas fa-dollar-sign fa-lg"></i></div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Total Sales</p>
                                <p class="text-2xl font-bold text-gray-800">₹{{ total_sales|floatformat:2 }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600"><i class="fas fa-coins fa-lg"></i></div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Total Profit</p>
                                <p class="text-2xl font-bold {% if total_profit < 0 %}text-red-600{% else %}text-gray-800{% endif %}">₹{{ total_profit|floatformat:2 }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600"><i class="fas fa-shopping-basket fa-lg"></i></div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-500">Products Sold</p>
                                <p class="text-2xl font-bold text-gray-800">{{ total_products_sold }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Seller Performance</h3>
                        <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100 overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b-2 border-gray-200">
                                        <th class="p-4 font-semibold text-gray-600">Seller</th>
                                        <th class="p-4 font-semibold text-gray-600">Products Sold</th>
                                        <th class="p-4 font-semibold text-gray-600">Profit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for seller in seller_sales %}
                                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                                        <td class="p-4 truncate">{{ seller.product__seller__name }}</td>
                                        <td class="p-4 truncate">{{ seller.total_quantity_sold }}</td>
                                        <td class="p-4 font-medium {% if seller.total_profit < 0 %}text-red-600{% else %}text-green-600{% endif %}">₹{{ seller.total_profit|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="3" class="text-center p-8 text-gray-500">No seller sales data for this period.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Top Products</h3>
                        <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100 overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b-2 border-gray-200">
                                        <th class="p-4 font-semibold text-gray-600">Product</th>
                                        <th class="p-4 font-semibold text-gray-600">Quantity</th>
                                        <th class="p-4 font-semibold text-gray-600">Profit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in product_sales %}
                                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                                        <td class="p-4 truncate">{{ product.product__product_name }}</td>
                                        <td class="p-4 truncate">{{ product.total_quantity_sold }}</td>
                                        <td class="p-4 font-medium {% if product.total_profit < 0 %}text-red-600{% else %}text-green-600{% endif %}">₹{{ product.total_profit|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="3" class="text-center p-8 text-gray-500">No product sales data for this period.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="customers-section" class="content-section hidden">
                <h2 class="text-3xl font-bold text-gray-700 mb-6">Manage Customers</h2>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="p-4 font-semibold text-gray-600 w-1/5">Name</th>
                                <th class="p-4 font-semibold text-gray-600 w-1/5">Username</th>
                                <th class="p-4 font-semibold text-gray-600 w-1/5 hidden sm:table-cell">Phone</th>
                                <th class="p-4 font-semibold text-gray-600 w-1/5 hidden lg:table-cell">Address</th>
                                <th class="p-4 font-semibold text-gray-600 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in customers %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="p-4 truncate">{{ customer.name }}</td>
                                <td class="p-4 truncate">{{ customer.username }}</td>
                                <td class="p-4 hidden sm:table-cell">{{ customer.phone }}</td>
                                <td class="p-4 truncate hidden lg:table-cell">{{ customer.address }}</td>
                                <td class="p-4 text-center">
                                    <a href="{% url 'delete_customer' customer.id %}" class="text-red-500 hover:text-red-700" onclick="return confirm('Are you sure you want to delete this customer?');">
                                        <i class="fas fa-trash-alt"></i> <span class="hidden sm:inline">Delete</span>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center p-8 text-gray-500">No customers found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="sellers-section" class="content-section hidden">
                <h2 class="text-3xl font-bold text-gray-700 mb-6">Manage Sellers</h2>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="p-4 font-semibold text-gray-600 w-1/5">Name</th>
                                <th class="p-4 font-semibold text-gray-600 w-1/5">Username</th>
                                <th class="p-4 font-semibold text-gray-600 w-1/5 hidden sm:table-cell">Phone</th>
                                <th class="p-4 font-semibold text-gray-600 w-1/5 hidden lg:table-cell">Kudumbasree Details</th>
                                <th class="p-4 font-semibold text-gray-600 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for seller in approved_sellers %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="p-4 truncate">{{ seller.name }}</td>
                                <td class="p-4 truncate">{{ seller.username }}</td>
                                <td class="p-4 hidden sm:table-cell">{{ seller.phone }}</td>
                                <td class="p-4 truncate hidden lg:table-cell">{{ seller.kudumbasree_details }}</td>
                                <td class="p-4 text-center">
                                     <a href="{% url 'delete_seller' seller.id %}" class="text-red-500 hover:text-red-700" onclick="return confirm('Are you sure you want to delete this seller?');">
                                        <i class="fas fa-trash-alt"></i> <span class="hidden sm:inline">Delete</span>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center p-8 text-gray-500">No approved sellers found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="approval-section" class="content-section hidden">
                <h2 class="text-3xl font-bold text-gray-700 mb-6">Seller Approval Requests</h2>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                           <tr class="border-b-2 border-gray-200">
                                <th class="p-4 font-semibold text-gray-600 w-1/4">Name</th>
                                <th class="p-4 font-semibold text-gray-600 w-1/4">Username</th>
                                <th class="p-4 font-semibold text-gray-600 w-1/4 hidden sm:table-cell">Passbook</th>
                                <th class="p-4 font-semibold text-gray-600 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                           {% for seller in pending_sellers %}
                            <tr class="border-b border-gray-100">
                                <td class="p-4 truncate">{{ seller.name }}</td>
                                <td class="p-4 truncate">{{ seller.username }}</td>
                                <td class="p-4 hidden sm:table-cell">
                                    <a href="{{ seller.passbook.url }}" target="_blank" class="text-[#87267e] hover:underline">View Passbook</a>
                                </td>
                                <td class="p-4 text-center space-x-2">
                                    <a href="{% url 'approve_seller' seller.id %}" class="bg-green-500 text-white px-3 py-2 text-sm rounded-md hover:bg-green-600">Accept</a>
                                    <a href="{% url 'reject_seller' seller.id %}" class="bg-red-500 text-white px-3 py-2 text-sm rounded-md hover:bg-red-600">Reject</a>
                                </td>
                            </tr>
                           {% empty %}
                            <tr>
                               <td colspan="4" class="text-center p-8 text-gray-500">No pending seller requests.</td>
                            </tr>
                           {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="community-section" class="content-section hidden">
                <h2 class="text-3xl font-bold text-gray-700 mb-6">Community Posts</h2>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 mb-8">
                    <h3 class="text-xl font-semibold mb-4">Create New Post</h3>
                    <form action="{% url 'add_post' %}" method="POST" enctype="multipart/form-data" class="space-y-4">
                        {% csrf_token %}
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea name="description" id="description" rows="4" class="w-full border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        <div>
                            <label for="image" class="block text-sm font-medium text-gray-700">Image</label>
                            <input type="file" name="image" id="image" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        </div>
                        <div class="text-right">
                            <button type="submit" class="bg-[#87267e] text-white font-semibold py-2 px-6 rounded-lg">Post</button>
                        </div>
                    </form>
                </div>

                <div class="space-y-4">
                    {% for post in posts %}
                    <div class="bg-white p-4 rounded-lg shadow-md border">
                        {% if post.image %}
                        <img src="{{ post.image.url }}" alt="Post Image" class="w-full h-64 object-cover rounded-lg mb-4">
                        {% endif %}
                        {% if post.description %}
                        <pre class="text-gray-700 mb-4 whitespace-pre-wrap">{{ post.description }}</pre>
                        {% endif %}
                        <div class="flex justify-between items-center text-sm text-gray-500">
                            <span>{{ post.created_at|date:"F d, Y" }}</span>
                            <div class="space-x-4">
                                <button class="update-post-btn text-blue-500 hover:underline"
                                    data-id="{{ post.id }}"
                                    data-description="{{ post.description|default:'' }}"
                                    data-action="{% url 'update_post' post.id %}">
                                    Edit
                                </button>
                                <a href="{% url 'delete_post' post.id %}" class="text-red-500 hover:underline" onclick="return confirm('Are you sure?')">Delete</a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-center text-gray-500">No community posts yet.</p>
                    {% endfor %}
                </div>
            </section>

        </main>
    </div>

    <div id="update-post-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                 <h3 class="text-xl font-bold text-gray-800">Update Post</h3>
                 <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="update-post-form" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label for="update_description" class="block text-sm font-medium">Description</label>
                        <textarea name="description" id="update_description" rows="6" class="w-full border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>
                    <div>
                        <label for="update_image" class="block text-sm font-medium">Replace Image (optional)</label>
                        <input type="file" name="image" id="update_image" class="w-full">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancel-update-btn" class="bg-gray-200 py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-[#87267e] text-white py-2 px-4 rounded-lg">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const allNavLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-nav-menu');

            function switchTab(targetId) {
                // Hide all sections
                contentSections.forEach(section => {
                    section.classList.add('hidden');
                });
                
                // Show the target section
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }

                // Update active link styles for all nav links
                allNavLinks.forEach(link => {
                    if (link.dataset.target === targetId) {
                        link.classList.add('active-link');
                    } else {
                        link.classList.remove('active-link');
                    }
                });
                
                // Close mobile menu on selection
                mobileMenu.classList.add('hidden');
            }

            allNavLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const targetId = event.currentTarget.dataset.target;
                    window.location.hash = targetId; // Update hash to preserve state
                    switchTab(targetId);
                });
            });

            // Toggle mobile menu
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
            
            // Function to handle hash changes on page load or back/forward
            function handleHashChange() {
                const hash = window.location.hash.substring(1);
                // Default to 'sales-report-section' if no hash or invalid hash
                const targetId = hash ? hash : 'sales-report-section';
                if(document.getElementById(targetId)) {
                    switchTab(targetId);
                } else {
                    switchTab('sales-report-section');
                }
            }
            
            // Handle initial page load
            handleHashChange();
            // Handle back/forward button navigation
            window.addEventListener('hashchange', handleHashChange);

            // --- MESSAGE TIMER LOGIC ---
            const alerts = document.querySelectorAll('.auto-dismiss-alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.transition = 'opacity 0.5s ease';
                    alert.style.opacity = '0';
                    setTimeout(() => {
                        alert.style.display = 'none';
                    }, 500);
                }, 2000);
            });
            
            // --- MODAL LOGIC for Community Posts ---
            const updateModal = document.getElementById('update-post-modal');
            const updateForm = document.getElementById('update-post-form');
            const updateDescription = document.getElementById('update_description');
            const closeBtn = document.getElementById('close-modal-btn');
            const cancelBtn = document.getElementById('cancel-update-btn');

            document.querySelectorAll('.update-post-btn').forEach(button => {
                button.addEventListener('click', function() {
                    updateForm.action = this.dataset.action;
                    updateDescription.value = this.dataset.description;
                    updateModal.classList.remove('hidden');
                });
            });

            const closeModal = () => updateModal.classList.add('hidden');
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            updateModal.addEventListener('click', (e) => {
                if (e.target === updateModal) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
